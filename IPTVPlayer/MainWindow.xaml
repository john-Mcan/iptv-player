<Window x:Class="IPTVPlayer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vlc="clr-namespace:LibVLCSharp.WPF;assembly=LibVLCSharp.WPF"
        Title="IPTV Player" Height="700" Width="1100"
        MinHeight="480" MinWidth="720"
        Background="{StaticResource BgBrush}"
        Icon="{StaticResource ChucaoIcon}"
        WindowStartupLocation="CenterScreen"
        Loaded="Window_Loaded"
        Closing="Window_Closing"
        KeyDown="Window_KeyDown">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top Bar -->
        <Border x:Name="TopBar" Grid.Row="0" Background="{StaticResource SurfaceBrush}"
                Padding="10,8" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="200"/>
                </Grid.ColumnDefinitions>

                <ComboBox x:Name="UrlBox" Grid.Column="0"
                          Style="{StaticResource UrlCombo}"
                          Text="{Binding PlaylistUrl, UpdateSourceTrigger=PropertyChanged}"
                          ItemsSource="{Binding RecentUrls}"
                          VerticalContentAlignment="Center"
                          KeyDown="UrlBox_KeyDown">
                    <ComboBox.ToolTip>URL de playlist M3U o ruta de archivo local</ComboBox.ToolTip>
                </ComboBox>

                <Button Grid.Column="1" Content="Cargar" Margin="8,0"
                        Style="{StaticResource AccentBtn}"
                        Command="{Binding LoadPlaylistCommand}"/>

                <TextBox Grid.Column="2"
                         Style="{StaticResource DarkTextBox}"
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Tag="Buscar canales..."
                         VerticalContentAlignment="Center"/>
            </Grid>
        </Border>

        <!-- Content: Sidebar + Video -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="SidebarColumn" Width="280"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Sidebar -->
            <Border x:Name="Sidebar" Grid.Column="0" Background="{StaticResource SurfaceBrush}"
                    BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Margin="12,10,12,6"
                               Foreground="{StaticResource TextDimBrush}" FontSize="11">
                        <Run Text="CANALES"/>
                        <Run Text=" ("/>
                        <Run Text="{Binding TotalChannels, Mode=OneWay}"/>
                        <Run Text=")"/>
                    </TextBlock>

                    <!-- Category Tabs -->
                    <ItemsControl Grid.Row="1" ItemsSource="{Binding Categories}" Margin="6,2,6,4">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <RadioButton GroupName="CategoryTabs" Margin="2"
                                             IsChecked="{Binding IsSelected, RelativeSource={RelativeSource Self}}"
                                             Click="CategoryTab_Click" Tag="{Binding}"
                                             Cursor="Hand">
                                    <RadioButton.Template>
                                        <ControlTemplate TargetType="RadioButton">
                                            <Border x:Name="TabBd" CornerRadius="4" Padding="8,5"
                                                    Background="{StaticResource SurfaceBrush}"
                                                    BorderBrush="{StaticResource BorderBrush}" BorderThickness="1">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding Name}" FontSize="11"
                                                               Foreground="{StaticResource TextBrush}"/>
                                                    <TextBlock FontSize="10" Margin="4,0,0,0"
                                                               Foreground="{StaticResource TextDimBrush}"
                                                               VerticalAlignment="Center"
                                                               Text="{Binding TotalChannels, StringFormat='({0})'}"/>
                                                </StackPanel>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsChecked" Value="True">
                                                    <Setter TargetName="TabBd" Property="Background" Value="{StaticResource AccentBrush}"/>
                                                    <Setter TargetName="TabBd" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                                </Trigger>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="TabBd" Property="Background" Value="{StaticResource SurfaceHighBrush}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </RadioButton.Template>
                                </RadioButton>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Loading -->
                    <ProgressBar Grid.Row="2" IsIndeterminate="True" Height="3"
                                 VerticalAlignment="Top"
                                 Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}"
                                 Foreground="{StaticResource AccentBrush}"
                                 Background="Transparent" BorderThickness="0"/>

                    <!-- Channel Tree -->
                    <TreeView x:Name="ChannelTree" Grid.Row="2" Margin="0,4,0,0"
                              ItemsSource="{Binding FilteredGroups}"
                              MouseDoubleClick="ChannelTree_MouseDoubleClick">
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Channels}">
                                <StackPanel Orientation="Horizontal" Margin="2,2">
                                    <TextBlock Text="&#xE8FD;" FontFamily="Segoe MDL2 Assets"
                                               FontSize="12" Margin="0,0,6,0"
                                               Foreground="{StaticResource AccentBrush}"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13"
                                               Foreground="{StaticResource TextBrush}"/>
                                    <TextBlock Text=" (" Foreground="{StaticResource TextDimBrush}" FontSize="11"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding Channels.Count}" Foreground="{StaticResource TextDimBrush}"
                                               FontSize="11" VerticalAlignment="Center"/>
                                    <TextBlock Text=")" Foreground="{StaticResource TextDimBrush}" FontSize="11"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                                <HierarchicalDataTemplate.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Margin="2,1">
                                            <Grid Width="24" Height="24" Margin="0,0,6,0" VerticalAlignment="Center">
                                                <TextBlock Text="&#xE774;" FontFamily="Segoe MDL2 Assets"
                                                           FontSize="14"
                                                           Foreground="{StaticResource TextDimBrush}"
                                                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                <Image Source="{Binding LogoUrl, Converter={StaticResource ImgLoad}, IsAsync=True}"
                                                       Width="24" Height="24"
                                                       Stretch="UniformToFill"
                                                       RenderOptions.BitmapScalingMode="HighQuality"/>
                                            </Grid>
                                            <TextBlock Text="{Binding Name}" FontSize="13"
                                                       Foreground="{StaticResource TextBrush}"
                                                       VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </HierarchicalDataTemplate.ItemTemplate>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>

                    <!-- Error Message -->
                    <Border Grid.Row="2" VerticalAlignment="Bottom" Margin="8" CornerRadius="4"
                            Background="#33EF4444" Padding="10,6">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ErrorMessage}" Value="">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="{Binding ErrorMessage}"
                                   Foreground="{StaticResource ErrorBrush}"
                                   TextWrapping="Wrap" FontSize="12"/>
                    </Border>
                </Grid>
            </Border>

            <!-- Splitter -->
            <GridSplitter x:Name="SidebarSplitter" Grid.Column="1" Width="3"
                          Background="{StaticResource BorderBrush}"
                          HorizontalAlignment="Center" VerticalAlignment="Stretch"/>

            <!-- Video Area -->
            <Grid Grid.Column="2" Background="Black">
                <vlc:VideoView x:Name="VideoView">
                    <Grid x:Name="VideoOverlay" Background="#01000000"
                          MouseMove="VideoOverlay_MouseMove"
                          MouseDown="VideoOverlay_MouseDown">

                        <!-- Placeholder when no media -->
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                                    Visibility="{Binding Player.HasMedia, Converter={StaticResource InvBoolToVis}}">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Player.IsReconnecting}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <TextBlock Text="&#xE714;" FontFamily="Segoe MDL2 Assets"
                                       FontSize="48" Foreground="#404048"
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="Selecciona un canal para reproducir"
                                       Foreground="#505058" FontSize="14" Margin="0,12,0,0"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>

                        <!-- Reconnection overlay -->
                        <Border HorizontalAlignment="Center" VerticalAlignment="Center"
                                Background="#DD1A1A1E" CornerRadius="10" Padding="28,20"
                                Visibility="{Binding Player.IsReconnecting, Converter={StaticResource BoolToVis}}">
                            <StackPanel HorizontalAlignment="Center">
                                <TextBlock Text="&#xE895;" FontFamily="Segoe MDL2 Assets"
                                           FontSize="28" Foreground="{StaticResource AccentBrush}"
                                           HorizontalAlignment="Center" Margin="0,0,0,10"/>
                                <ProgressBar IsIndeterminate="True" Height="3" Width="140"
                                             Foreground="{StaticResource AccentBrush}"
                                             Background="{StaticResource SurfaceHighBrush}"
                                             BorderThickness="0" Margin="0,0,0,12"/>
                                <TextBlock Text="{Binding Player.ReconnectStatus}"
                                           Foreground="{StaticResource TextBrush}" FontSize="13"
                                           HorizontalAlignment="Center" Margin="0,0,0,14"/>
                                <Button Content="Cancelar"
                                        Style="{StaticResource PlayerBtn}"
                                        Command="{Binding Player.CancelReconnectCommand}"
                                        HorizontalAlignment="Center" Padding="16,6"/>
                            </StackPanel>
                        </Border>

                        <!-- Fullscreen overlay controls -->
                        <Border x:Name="FullscreenOverlay" VerticalAlignment="Bottom"
                                Visibility="Collapsed" Opacity="0">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                    <GradientStop Color="#00000000" Offset="0"/>
                                    <GradientStop Color="#CC000000" Offset="0.3"/>
                                    <GradientStop Color="#EE000000" Offset="1"/>
                                </LinearGradientBrush>
                            </Border.Background>
                            <StackPanel Margin="16,30,16,10">
                                <Slider x:Name="FsSeekSlider" Style="{StaticResource SeekSlider}"
                                        Value="{Binding Player.Position, Mode=TwoWay}"
                                        VerticalAlignment="Center" Margin="0,0,0,6"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <Button Grid.Column="0" Style="{StaticResource IconBtn}"
                                            Command="{Binding Player.TogglePlayPauseCommand}" Margin="0,0,2,0">
                                        <Grid>
                                            <TextBlock Text="&#xE768;"
                                                       Visibility="{Binding Player.IsPlaying, Converter={StaticResource InvBoolToVis}}"/>
                                            <TextBlock Text="&#xE769;"
                                                       Visibility="{Binding Player.IsPlaying, Converter={StaticResource BoolToVis}}"/>
                                        </Grid>
                                    </Button>

                                    <Button Grid.Column="1" Style="{StaticResource IconBtn}"
                                            Content="&#xE71A;"
                                            Command="{Binding Player.StopCommand}" Margin="0,0,6,0"/>

                                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,8,0">
                                        <TextBlock Foreground="{StaticResource TextDimBrush}" FontSize="12"
                                                   FontFamily="Consolas" VerticalAlignment="Center">
                                            <Run Text="{Binding Player.CurrentTime, Converter={StaticResource TimeToStr}, Mode=OneWay}"/>
                                            <Run Text="/"/>
                                            <Run Text="{Binding Player.Duration, Converter={StaticResource TimeToStr}, Mode=OneWay}"/>
                                        </TextBlock>
                                        <TextBlock Margin="10,0,0,0" FontSize="11" VerticalAlignment="Center"
                                                   Foreground="{StaticResource TextDimBrush}"
                                                   Visibility="{Binding Player.IsLive, Converter={StaticResource BoolToVis}}">
                                            <Run Text="&#x23FA;" Foreground="#EF4444"/>
                                            <Run Text=" EN VIVO"/>
                                        </TextBlock>
                                    </StackPanel>

                                    <TextBlock Grid.Column="3" Text="{Binding Player.CurrentChannelName}"
                                               Foreground="White" FontSize="12" VerticalAlignment="Center"
                                               Margin="0,0,8,0" TextTrimming="CharacterEllipsis"/>

                                    <Button Grid.Column="4" Style="{StaticResource IconBtn}"
                                            Command="{Binding Player.ToggleMuteCommand}">
                                        <Grid>
                                            <TextBlock Text="&#xE767;"
                                                       Visibility="{Binding Player.IsMuted, Converter={StaticResource InvBoolToVis}}"/>
                                            <TextBlock Text="&#xE74F;"
                                                       Visibility="{Binding Player.IsMuted, Converter={StaticResource BoolToVis}}"/>
                                        </Grid>
                                    </Button>

                                    <Slider Grid.Column="5" Style="{StaticResource VolumeSlider}"
                                            Value="{Binding Player.Volume, Mode=TwoWay}"
                                            Maximum="100" VerticalAlignment="Center" Margin="0,0,8,0"/>

                                    <ComboBox Grid.Column="6" Style="{StaticResource DarkCombo}"
                                              ItemsSource="{Binding Player.AudioTracks}"
                                              SelectedItem="{Binding Player.SelectedAudioTrack}"
                                              DisplayMemberPath="Name" Margin="0,0,4,0">
                                        <ComboBox.ToolTip>Pista de Audio</ComboBox.ToolTip>
                                    </ComboBox>

                                    <ComboBox Grid.Column="7" Style="{StaticResource DarkCombo}"
                                              ItemsSource="{Binding Player.SubtitleTracks}"
                                              SelectedItem="{Binding Player.SelectedSubtitleTrack}"
                                              DisplayMemberPath="Name" Margin="0,0,4,0">
                                        <ComboBox.ToolTip>Subtítulos</ComboBox.ToolTip>
                                    </ComboBox>

                                    <Button Grid.Column="8" Style="{StaticResource IconBtn}"
                                            Click="Fullscreen_Click">
                                        <Button.ToolTip>Salir de Pantalla Completa (Esc)</Button.ToolTip>
                                        <TextBlock Text="&#xE73F;"/>
                                    </Button>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </Grid>
                </vlc:VideoView>
            </Grid>
        </Grid>

        <!-- Player Controls -->
        <Border x:Name="ControlsBar" Grid.Row="2" Background="{StaticResource SurfaceBrush}"
                Padding="8,6" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" Style="{StaticResource IconBtn}"
                        Command="{Binding Player.TogglePlayPauseCommand}" Margin="0,0,2,0">
                    <Grid>
                        <TextBlock Text="&#xE768;"
                                   Visibility="{Binding Player.IsPlaying, Converter={StaticResource InvBoolToVis}}"/>
                        <TextBlock Text="&#xE769;"
                                   Visibility="{Binding Player.IsPlaying, Converter={StaticResource BoolToVis}}"/>
                    </Grid>
                </Button>

                <Button Grid.Column="1" Style="{StaticResource IconBtn}"
                        Content="&#xE71A;"
                        Command="{Binding Player.StopCommand}" Margin="0,0,6,0"/>

                <Slider x:Name="SeekSlider" Grid.Column="2"
                        Style="{StaticResource SeekSlider}"
                        Value="{Binding Player.Position, Mode=TwoWay}"
                        VerticalAlignment="Center" Margin="4,0"/>

                <TextBlock Grid.Column="3" VerticalAlignment="Center" Margin="6,0"
                           Foreground="{StaticResource TextDimBrush}" FontSize="12"
                           FontFamily="Consolas">
                    <Run Text="{Binding Player.CurrentTime, Converter={StaticResource TimeToStr}, Mode=OneWay}"/>
                    <Run Text="/"/>
                    <Run Text="{Binding Player.Duration, Converter={StaticResource TimeToStr}, Mode=OneWay}"/>
                </TextBlock>

                <Button Grid.Column="4" Style="{StaticResource IconBtn}"
                        Command="{Binding Player.ToggleMuteCommand}">
                    <Grid>
                        <TextBlock Text="&#xE767;"
                                   Visibility="{Binding Player.IsMuted, Converter={StaticResource InvBoolToVis}}"/>
                        <TextBlock Text="&#xE74F;"
                                   Visibility="{Binding Player.IsMuted, Converter={StaticResource BoolToVis}}"/>
                    </Grid>
                </Button>

                <Slider Grid.Column="5" Style="{StaticResource VolumeSlider}"
                        Value="{Binding Player.Volume, Mode=TwoWay}"
                        Maximum="100" VerticalAlignment="Center" Margin="0,0,8,0"/>

                <ComboBox Grid.Column="6" Style="{StaticResource DarkCombo}"
                          ItemsSource="{Binding Player.AudioTracks}"
                          SelectedItem="{Binding Player.SelectedAudioTrack}"
                          DisplayMemberPath="Name" Margin="0,0,4,0">
                    <ComboBox.ToolTip>Pista de Audio</ComboBox.ToolTip>
                </ComboBox>

                <ComboBox Grid.Column="7" Style="{StaticResource DarkCombo}"
                          ItemsSource="{Binding Player.SubtitleTracks}"
                          SelectedItem="{Binding Player.SelectedSubtitleTrack}"
                          DisplayMemberPath="Name" Margin="0,0,4,0">
                    <ComboBox.ToolTip>Subtítulos</ComboBox.ToolTip>
                </ComboBox>

                <Button Grid.Column="8" Style="{StaticResource IconBtn}"
                        Content="&#xE8A7;" Click="PiP_Click" Margin="0,0,2,0">
                    <Button.ToolTip>Picture in Picture</Button.ToolTip>
                </Button>

                <Button Grid.Column="9" Style="{StaticResource IconBtn}"
                        Click="Fullscreen_Click">
                    <Button.ToolTip>Pantalla Completa (F11)</Button.ToolTip>
                    <Grid>
                        <TextBlock x:Name="FsIconExpand" Text="&#xE740;"/>
                        <TextBlock x:Name="FsIconRestore" Text="&#xE73F;" Visibility="Collapsed"/>
                    </Grid>
                </Button>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border x:Name="StatusBar" Grid.Row="3" Background="{StaticResource BgBrush}" Padding="10,4"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0">
            <Grid>
                <TextBlock Text="{Binding Player.StatusText}"
                           Foreground="{StaticResource TextDimBrush}" FontSize="11"/>
                <TextBlock HorizontalAlignment="Right" FontSize="11"
                           Foreground="{StaticResource TextDimBrush}"
                           Visibility="{Binding Player.IsLive, Converter={StaticResource BoolToVis}}">
                    <Run Text="&#x23FA;" Foreground="#EF4444"/>
                    <Run Text=" EN VIVO"/>
                </TextBlock>
            </Grid>
        </Border>
    </Grid>
</Window>
